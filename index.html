<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>グループワークアウト予約</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    /* 右端の細いナビ（固定） */
    .side-nav{position:fixed;right:-5px;top:80%;transform:translateY(-50%) translateX(13px);background:#13ca5e;display:flex;flex-direction:column;align-items:center;padding:4px;border-radius:10px 0 0 10px;z-index:1000;width:35px}
    .side-nav a{display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-decoration:none;font-size:10px;margin:5px 0;padding:5px;border-radius:5px;width:30px;height:30px;text-align:center}
    .side-nav a span{font-size:24px;position:absolute;left:0;top:13px}
    @media (max-width:600px){.side-nav{right:2px;width:30px}.side-nav a{width:28px;height:28px}.side-nav a i{font-size:12px}}

    /* ベース */
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",sans-serif;background:#e7e7e7;display:flex;justify-content:center;align-items:flex-start;margin:0;padding:10px}
    .container{background:#fff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);width:92%;max-width:520px;padding:22px;box-sizing:border-box;margin:0 auto}
    h1{background:linear-gradient(135deg,#13ca5e,#0fa958);color:#fff;padding:20px;border-radius:0 15px 0 45px;text-align:center;display:block;margin:-20px -15px 20px -15px;font-size:26px;font-weight:700;box-shadow:inset 0 -5px 10px rgba(0,0,0,.05)}

    .label{display:flex;justify-content:space-between;align-items:center;margin:14px 0 6px;background:#13ca5e;color:#fff;border-radius:6px;font-weight:700;font-size:16px;padding:8px 10px}
    .required{background:#ff2d2d;color:#fff;border-radius:4px;padding:1px 6px;margin-left:8px;font-size:11px}
    .optional{background:#6c757d;color:#fff;border-radius:4px;padding:1px 6px;margin-left:8px;font-size:11px}

    input[type="text"],input[type="tel"],select,textarea,input[type="datetime-local"]{width:100%;padding:12px;border:1.5px solid #dcdcdc;border-radius:8px;box-sizing:border-box;font-size:16px;background:#fff;transition:border-color .2s,box-shadow .2s}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#13ca5e;box-shadow:0 0 0 3px rgba(19,202,94,.15)}
    textarea{min-height:110px;resize:vertical}

    /* 希望日時：縦並び */
    .dt-group{margin-top:8px;margin-bottom:10px}
    .sub-label{font-size:13px;font-weight:700;color:#333;margin:4px 0 6px;display:inline-flex;align-items:center;gap:8px;background:#f1fff6;border:1px solid #bfead1;border-radius:6px;padding:4px 8px}

    .note{margin-top:10px;font-size:12px;color:#666;line-height:1.6}
    .submit{width:100%;padding:14px;border:none;border-radius:10px;background:#dc3545;color:#fff;font-size:18px;font-weight:700;cursor:pointer}
    .submit:active{transform:scale(.99)}

    /* 候補チップ */
    .slots-panel{margin:8px 0 12px;border:1px solid #e7f6ec;background:#f7fffa;border-radius:10px;padding:10px}
    .slots-title{font-size:12px;color:#0f5132;margin:0 0 6px;font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid #b7e4c7;background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;line-height:1;cursor:default;pointer-events:none}
    .chip.active{background:#d1f2df;border-color:#88d4ad}
    .chip:active{transform:scale(.98)}
  </style>
</head>
<body>
  <!-- 右側ナビ（任意） -->
  <div class="side-nav" id="sideNav">
    <a href="#section-submit" aria-label="送信へ"><span>⇩</span><i class="fas fa-paper-plane"></i></a>
  </div>

  <div class="container">
    <h1>グループワークアウト予約</h1>

    <!-- ① お名前（必須） -->
    <div class="label">お名前 <span class="required">必須</span></div>
    <input type="text" id="name" placeholder="例：山田 太郎" autocomplete="name" />

    <!-- ② 電話番号（必須） -->
    <div class="label">電話番号 <span class="required">必須</span></div>
    <input type="tel" id="phone" inputmode="tel" placeholder="例：09012345678" autocomplete="tel" />

    <!-- ③ 会員/非会員（選択形式・必須） -->
    <div class="label">会員・非会員をお選びください <span class="required">必須</span></div>
    <select id="memberStatus" aria-label="会員ステータス">
      <option value="" disabled selected>選択してください</option>
      <option>会員</option>
      <option>非会員</option>
    </select>

    <!-- ③.5 メニュー名（必須） -->
    <div class="label">メニュー名をお選びください <span class="required">必須</span></div>
    <select id="menuName" aria-label="メニュー名">
      <option value="" disabled selected>選択してください</option>
      <option>ピラティス</option>
      <option>コーディネーション</option>
      <option>チューニング</option>
      <option>脂肪燃焼</option>
      <option>ストレッチ</option>
      <option>ルーシーダットン</option>
      <option>コア</option>
      <option>ナイトコア</option>
      <option>ゆっくりヨガ</option>
      <option>ヨガ</option>
    </select>

    <!-- メニューの候補表示（参考用） -->
    <div id="slotsPanel" class="slots-panel" style="display:none;">
      <p class="slots-title">このメニューで予約できる候補</p>
      <div class="chips" id="chipsHolder"></div>
      <p class="note">※候補は参考用です。下の「希望日時」は第1のみ必須、<b>第2・第3は任意</b>です。</p>
    </div>

    <!-- ④ 希望日時（第1〜第3：第1は必須／第2・第3は任意） -->
    <div class="label">希望日時（第1〜第3） <span class="required">第1は必須・第2/第3は任意</span></div>

    <div class="dt-group">
      <div class="sub-label">第1希望 <span class="required">必須</span></div>
      <input type="datetime-local" id="date1" aria-label="第1希望日時" />
    </div>
    <div class="dt-group">
      <div class="sub-label">第2希望 <span class="optional">任意</span></div>
      <input type="datetime-local" id="date2" aria-label="第2希望日時（任意）" />
    </div>
    <div class="dt-group">
      <div class="sub-label">第3希望 <span class="optional">任意</span></div>
      <input type="datetime-local" id="date3" aria-label="第3希望日時（任意）" />
    </div>

    <!-- ⑤ 備考（任意） -->
    <div class="label">備考</div>
    <textarea id="note" placeholder="連絡希望時間、注意点などがあればご記入ください"></textarea>

    <button id="section-submit" class="submit" onclick="submitForm()">送信する</button>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    const LIFF_ID = "2008384607-MY53PJ6A";

    /* ========== スケジュール定義（メニュー→曜日→時間帯） ========== */
    const MENU_SCHEDULE = {
      'ピラティス':       { '月': ['10:00-10:50'], '金': ['10:00-10:50'] },
      'コーディネーション': { '火': ['10:00-10:50'], '木': ['16:00-16:50'], '金': ['19:30-20:20'] },
      'チューニング':     { '水': ['10:00-10:50'], '金': ['16:00-16:50'] },
      '脂肪燃焼':        { '木': ['10:00-10:50'], '火': ['16:00-16:50'], '土': ['16:00-16:50（第2・第4）'] },
      'ストレッチ':       { '土': ['10:00-10:50','16:00-16:50（第1・第3・第5）'], '月': ['16:00-16:50'], '木': ['19:30-20:20'] },
      'ルーシーダットン':  { '土': ['11:00-11:50'] },
      'コア':            { '水': ['16:00-16:50'] },
      'ナイトコア':       { '火': ['19:30-20:20'] },
      'ゆっくりヨガ':      { '水': ['19:30-20:20'] },
      'ヨガ':            { '土': ['17:00-17:50（第2・第4のみ）'] },
    };

    /* ========== 入力保存（name/phone/memberStatus/note/menuName） ========== */
    function saveInput(id){ localStorage.setItem(id, document.getElementById(id).value); }
    ["name","phone","memberStatus","note","menuName"].forEach(id=>{
      document.addEventListener("input",(e)=>{ if(e.target && e.target.id===id) saveInput(id); });
      const el = document.getElementById(id);
      if(el && el.tagName==="SELECT"){ el.addEventListener("change", ()=>saveInput(id)); }
    });

    /* ========== 候補描画 ========== */
    function renderSlots(menu){
      const panel = document.getElementById('slotsPanel');
      const holder = document.getElementById('chipsHolder');
      holder.innerHTML = '';
      if(!menu || !MENU_SCHEDULE[menu]){ panel.style.display='none'; return; }

      const order = ['月','火','水','木','金','土','日'];
      const entries = Object.entries(MENU_SCHEDULE[menu]).sort(
        (a,b)=> order.indexOf(a[0]) - order.indexOf(b[0])
      );

      entries.forEach(([day, times])=>{
        times.forEach(t=>{
          const chip = document.createElement('span');
          chip.className='chip';
          chip.textContent = `${day} ${t}`;
          holder.appendChild(chip);
        });
      });

      panel.style.display='block';
    }

    /* ========== 初期化 ========== */
    document.addEventListener("DOMContentLoaded", async () => {
      try { await liff.init({ liffId: LIFF_ID }); }
      catch (e) { console.error("LIFF初期化に失敗:", e); }

      // 前回値の復元
      ["name","phone","memberStatus","note","menuName"].forEach(id=>{
        const v = localStorage.getItem(id);
        if(v) document.getElementById(id).value = v;
      });

      // 過去日時の選択防止（端末ローカル時刻基準）
      const toLocal = (d)=>{ const z=d.getTimezoneOffset(); const l=new Date(d.getTime()-z*60000); return l.toISOString().slice(0,16); };
      const nowLocal = toLocal(new Date());
      ["date1","date2","date3"].forEach(id => { const el=document.getElementById(id); if(el) el.min = nowLocal; });

      // メニュー候補の初回描画
      renderSlots(document.getElementById('menuName').value);

      // メニュー変更時に候補を更新
      document.getElementById('menuName').addEventListener('change', (e)=>{
        renderSlots(e.target.value);
      });
    });

    /* ========== 送信処理 ========== */
    function formatJP(datetime){
      if(!datetime) return "";
      const d = new Date(datetime);
      if (isNaN(d)) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}年${m}月${day}日 ${hh}:${mm}`;
    }

    function submitForm(){
      const name    = document.getElementById("name").value.trim();
      const phone   = document.getElementById("phone").value.trim();
      const status  = document.getElementById("memberStatus").value;
      const menu    = document.getElementById("menuName").value;

      const date1   = document.getElementById("date1").value;
      const date2   = document.getElementById("date2").value;
      const date3   = document.getElementById("date3").value;
      const note    = document.getElementById("note").value.trim();

      // 必須チェック（第1のみ必須）
      if(!name){ alert("お名前をご入力ください。"); return; }
      if(!phone){ alert("電話番号をご入力ください。"); return; }
      if(!status){ alert("会員・非会員を選択してください。"); return; }
      if(!menu){ alert("メニュー名を選択してください。"); return; }
      if(!date1){ alert("希望日時は第1希望をご入力ください。第2・第3は任意です。"); return; }

      const selectedChips = Array.from(document.querySelectorAll('.chip.active')).map(c=>c.textContent).join('、');

      const message =
`【グループワークアウト予約】
お名前：${name}

電話番号：${phone}

会員ステータス：${status}
メニュー名：${menu}

候補メモ：${selectedChips || "（未選択）"}

【希望日時】
・第1希望：${formatJP(date1)}
・第2希望：${formatJP(date2) || "（未入力）"}
・第3希望：${formatJP(date3) || "（未入力）"}

備考：${note || "（なし）"}`;

      liff.sendMessages([{ type:"text", text: message }])
        .then(() => {
          alert("送信が完了しました。ご連絡をお待ちください。");
          liff.closeWindow();
        })
        .catch(err => {
          console.error("送信失敗:", err);
          alert("送信に失敗しました。電波状況をご確認のうえ、再度お試しください。");
        });
    }
  </script>
</body>
</html>
